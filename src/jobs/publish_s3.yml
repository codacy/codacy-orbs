description: Publish files to S3

executor: aws

parameters:
  public:
    type: boolean
    description: Whether to store in the public bucket
  path:
    type: string
    description: Path to store the files in S3
  files:
    type: string
    description: Files to publish separated by space

steps:
  - attach_workspace:
      at: ~/workdir

  - run_aws:
      cmd_name: Send files to S3
      cmd: |
        if [[ << parameters.public >> ]]; then
          bucket=$AWS_PUBLIC_ARTIFACTS_BUCKET
        else
          bucket=$AWS_PRIVATE_ARTIFACTS_BUCKET
        fi

        for file in << parameters.files >> ; do
          filename=$(basename $file)
          AWS_PROFILE=production aws s3 cp $file $bucket/<< parameters.path >>/$(cat .version)/$filename
        done
        if $(grep -q -E '^[0-9]+\.[0-9]+\.[0-9]+$' .version); then
          cat .version | tr -d '\n' | AWS_PROFILE=production aws s3 cp - $bucket/<< parameters.path >>/latest
        fi
