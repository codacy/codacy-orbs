description: "A default sbt job for Windows"

executor: win

parameters:
  cmd:
    description: "SBT command to run"
    type: string
  cache_prefix:
    description: "The prefix of cache to be used"
    type: string
    default: sbt-win-cache-052020
  persist_to_workspace:
    description: "Whether to persist the workspace or not at the end of the job"
    type: boolean
    default: false
  persist_to_workspace_path:
    description: "The folder to be persisted"
    type: string
    default: "*"
environment:
  AWS_PROFILE: << parameters.aws_profile >>
  AWS_DEFAULT_REGION: << parameters.region >>

steps:
  - attach_workspace:
      at: ~/workdir
  - run:
      name: Download and install sbt
      command: |
        Invoke-Expression (New-Object System.Net.WebClient).DownloadString('https://get.scoop.sh')
        scoop install sbt
  - run:
      name: Uncompress local targets
      command: |
        if ((Test-Path "targets.tar.gz")) {
          echo "unpacking persisted workspace"
          tar -xf targets.tar.gz
        } else {
          echo "no persisted workspace found"
        }
  - sbt_win_cached:
      cmd: << parameters.cmd >>
      cache_prefix: << parameters.cache_prefix >>
  - when:
      condition: << parameters.persist_to_workspace >>
      steps:
        - persist_to_workspace:
            root: ~/workdir
            paths:
              - << parameters.persist_to_workspace_path >>
