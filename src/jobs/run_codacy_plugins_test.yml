description: "Runs codacy-plugins-test on a tool"

executor: machine

parameters:
  version:
    type: string
    description: "codacy-plugins-test version"

steps:
  - attach_workspace:
      at: ~/
  - restore_cache:
      key: codacy-plugins-test-cache-<< parameters.version >>
  - attach_workspace:
      at: ~/
  - run:
      command: |
        mkdir -p codacy-plugins-test
        cd codacy-plugins-test
        FILENAME=codacy-plugins-test-<< parameters.version >>
        LINK="https://bintray.com/codacy/Binaries/download_file?file_path=<< parameters.version >>%2Fcodacy-plugins-test-linux"
        if [ ! -f "$FILENAME" ]; then
          wget $LINK -O $FILENAME
          chmod +x $FILENAME
        fi
        docker load --input ~/workdir/docker-image.tar
        ./$FILENAME json $CIRCLE_PROJECT_REPONAME:latest
        ./$FILENAME pattern $CIRCLE_PROJECT_REPONAME:latest
  - save_cache:
      key: codacy-plugins-test-cache-<< parameters.version >>
      paths:
        - ~/codacy-plugins-test
