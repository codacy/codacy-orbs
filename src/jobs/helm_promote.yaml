description: "Set version and publish to chart museum"

parameters:
  version:
    description: "Name of the helm chart"
    type: string
    default: "$(cat .version)"

  chart_name:
    description: "Name of the helm chart"
    type: string

  source_charts_repo_url:
    description: "Domain for the repo to download the chart"
    type: string
    default: "https://charts.codacy.com/incubator"

  target_charts_repo_url:
    description: "Domain for the repo to upload the chart"
    type: string
    default: "https://charts.codacy.com/stable"

  target_charts_repo_user:
    description: "Username for the repo to upload the chart"
    type: string
    default: ${CHARTS_REPO_USER}

  target_charts_repo_pass:
    description: "Password for the repo to upload the chart"
    type: string
    default: ${CHARTS_REPO_PASS}

executor: aws

steps:
  - attach_workspace:
      at: ~/workdir

  - deploy:
      name: Push to charts museum
      command: |
        export TMP_DIR_PATH=$(mktemp -d)
        helm fetch -d ${TMP_DIR_PATH} --repo << parameters.source_charts_repo_url >> << parameters.chart_name >> --version << parameters.version >>
        helm push ${TMP_DIR_PATH}/*.tgz << parameters.target_charts_repo_url >> -u "<< parameters.target_charts_repo_user >>" -p "<< parameters.target_charts_repo_pass >>"
