description: Checkout and write the version file

parameters:
  write_sbt_version:
    description: If a version.sbt file should be written after version is generated
    type: boolean
    default: false
  overwrite_package_json_version:
    description: If the version in `package.json` should be overwritten after version is generated
    type: boolean
    default: false
  update_submodules:
    type: boolean
    default: false
    description: Updates git submodules if true
  dev_branch:
    type: string
    default: "dev"
    description: Overrides the default dev branch (dev).
  release_branch:
    type: string
    default: "master"
    description: Overrides the default release branch (master).
  version_prefix:
    type: string
    default: ""
    description: Version prefix ("v" to tag versions like `v1.0.0`).

executor: versioning

steps:
  - run:
      name: Update github.com host keys
      command: |
        apk add -U openssh-keygen curl jq
        mkdir -p ~/.ssh
        if [ -f .ssh/known_hosts ] ; then ssh-keygen -R github.com ; fi
        curl -L https://api.github.com/meta | jq -r '.ssh_keys | .[]' | sed -e 's/^/github.com /' >> ~/.ssh/known_hosts

  - checkout

  - run:
      name: Set version
      command: /bin/git-version --dev-branch "<<parameters.dev_branch>>" --release-branch "<<parameters.release_branch>>" --version-prefix "<<parameters.version_prefix>>" > .version

  - run:
      name: Current version
      command: cat .version

  - when:
      condition: <<parameters.write_sbt_version>>
      steps:
        - run:
            name: Set SBT version
            command: echo "ThisBuild / version := \"$(cat .version)\"" > version.sbt

  - when:
      condition: <<parameters.overwrite_package_json_version>>
      steps:
        - run:
            name: Set package.json version
            command: |
              mv package.json temp.json
              apk add --no-cache jq
              jq -r ".version |= \"$(cat .version)\"" temp.json > package.json
              rm temp.json

  - when:
      condition: <<parameters.update_submodules>>
      steps:
        - run:
            name: Update git submodules
            command: git submodule update --init --recursive

  - persist_to_workspace:
      root: ~/
      paths:
        - 'workdir/*'
        - '.ssh/known_hosts'
