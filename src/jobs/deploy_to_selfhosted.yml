description: "A job to deploy latest dev components to self-hosted"

executor: do

parameters:
  chart_name:
    description: The helm release name to be installed.
    type: string
    default: "default-release"
  namespace:
    description: The target namespace for the release.
    type: string
    default: "codacy-dev"
  helm_install_extra_flags:
    description: Extra parameters to be passed to the helm install command.
    type: string
    default: ""

steps:
  - run:
      name: Set cluster to digital ocean
      command: |
        doctl auth init -t $DO_TOKEN &>/dev/null
        doctl kubernetes cluster kubeconfig save "$DOKS_CLUSTER_NAME" --set-current-context
  - run:
      name: Add unstable repository
      command: |
        helm repo add codacy-unstable https://charts.codacy.com/unstable
        helm repo update
  - deploy:
      name: Install component
      command: |
        curl -s -o values-production.yaml https://raw.githubusercontent.com/codacy/chart/master/codacy/values-production.yaml
        curl -s -o values.yaml https://raw.githubusercontent.com/codacy/chart/master/codacy/values.yaml
        version=$(helm search repo codacy-unstable/<< parameters.chart_name >> --devel -o json | jq -r ".[] | .version")

        helm upgrade --install << parameters.chart_name >> codacy-unstable/<< parameters.chart_name >> \
        --devel \
        --atomic \
        --timeout=600s \
        --namespace << parameters.namespace >> \
        -f values.yaml \
        -f values-production.yaml \
        --version $version \
        << parameters.helm_install_extra_flags >>
