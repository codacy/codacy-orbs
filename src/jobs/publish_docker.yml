description: Publish to Docker hub

executor: machine

parameters:
  path:
    type: string
    description: Path to the docker tar
    default: ~/workdir/docker-image.tar
  docker_name:
    type: string
    description: Docker name
    default: $CIRCLE_PROJECT_REPONAME
  docker_load:
    type: boolean
    description: Load docker images from path
    default: false

steps:
  - attach_workspace:
      at: ~/
  - when:
      condition: << parameters.docker_load >>
      steps:
        - run:
            name: Load docker
            command: docker load --input << parameters.path >>
  - run:
      name: Publish to Docker
      command: |
        docker login -u "$DOCKER_USER" -p "$DOCKER_PASS"
        docker tag "<< parameters.docker_name >>" "codacy/<< parameters.docker_name >>:$(cat ~/workdir/.version)"
        docker push "codacy/<< parameters.docker_name >>:$(cat ~/workdir/.version)"
        if [ "${CIRCLE_BRANCH}" == "master" ]; then
          docker tag "<< parameters.docker_name >>" "codacy/<< parameters.docker_name >>:latest"
          docker push "codacy/<< parameters.docker_name >>:latest"
        elif [ "${CIRCLE_BRANCH}" == "dev" ]; then
          docker tag "<< parameters.docker_name >>" "codacy/<< parameters.docker_name >>:dev"
          docker push "codacy/<< parameters.docker_name >>:dev"
        fi
